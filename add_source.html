{% extends "writer/base.html" %}

{% block content %}
<div class="max-w-2xl mx-auto">
  <div class="bg-surface border border-border rounded-xl p-8">
    <h2 class="text-2xl font-semibold text-text-primary mb-6">
      Add {{ type|title }} Source
    </h2>

    <form hx-post="/project/{{ project.id }}/add-{{ type }}/" 
          hx-target="#content" 
          hx-push-url="/project/{{ project.id }}/"
          hx-encoding="multipart/form-data"
          x-data="{ 
            title: '', 
            content: '', 
            isSubmitting: false,
            get characterCount() { return this.content.length; },
            get wordCount() { return this.content.trim() ? this.content.trim().split(/\s+/).length : 0; }
          }"
          @htmx:before-request="isSubmitting = true"
          @htmx:after-request="isSubmitting = false; showToast('Source added', 'success')">
      {% csrf_token %}

      <div class="mb-6">
        <label class="block text-sm font-medium text-text-secondary mb-2">
          Source Title
        </label>
        <input name="title" 
               x-model="title"
               class="w-full px-4 py-3 bg-background border border-border rounded-lg text-text-primary placeholder-muted focus:border-primary focus:outline-none"
               placeholder="Enter a descriptive title" 
               required />
      </div>

      {% if type == "text" %}
      <div class="mb-6">
        <label class="block text-sm font-medium text-text-secondary mb-2">
          Content
        </label>
        <textarea name="text" 
                  x-model="content"
                  rows="12"
                  class="w-full px-4 py-3 bg-background border border-border rounded-lg text-text-primary placeholder-muted focus:border-primary focus:outline-none"
                  placeholder="Paste your text content here..."></textarea>
        <div class="mt-2 flex items-center justify-between text-xs">
          <span :class="characterCount > 8000 ? 'text-amber-500' : characterCount > 9500 ? 'text-error' : 'text-muted'">
            <span x-text="characterCount"></span>/10,000 characters Â· 
            <span x-text="wordCount"></span> words
          </span>
        </div>
      </div>
      {% else %}
      <div class="mb-6">
        <label class="block text-sm font-medium text-text-secondary mb-2">
          Upload Audio File
        </label>
        <input type="file" 
               name="file" 
               accept="audio/*" 
               required
               class="w-full px-4 py-3 bg-background border border-border rounded-lg text-text-primary file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-primary file:text-background file:font-medium hover:file:bg-primary-hover" />
        <p class="mt-2 text-xs text-muted">
          Supported formats: MP3, WAV, M4A (max 50MB)
        </p>
      </div>
      {% endif %}

      <div class="flex gap-3">
        <button type="submit"
                :disabled="isSubmitting || title.trim().length === 0"
                :class="isSubmitting || title.trim().length === 0 ? 'bg-muted cursor-not-allowed opacity-70' : 'bg-primary hover:bg-primary-hover'"
                class="flex-1 px-4 py-3 text-background rounded-lg font-medium">
          <span x-show="!isSubmitting">Add Source</span>
          <span x-show="isSubmitting" class="flex items-center justify-center gap-2">
            <svg class="spinner w-4 h-4" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Processing...
          </span>
        </button>
        
        <a hx-get="/project/{{ project.id }}/" 
           hx-target="#content" 
           hx-push-url="true"
           class="px-4 py-3 bg-background border border-border hover:border-primary text-text-primary rounded-lg font-medium">
          Cancel
        </a>
      </div>
    </form>
  </div>
</div>
{% endblock %}
